### Разбор HTML для получения индекса Хирша

Рассмотрим процесс решения практической задачи в командной строке Linux по получению и обработке данных публикационной активности исследователя с целью вычисления его индекса Хирша. Данные для вычисления будем получать из Российской научной электронной библиотеки Elibrary по протоколу HTTP.

Индекс Хирша – это наукометрический показатель, предложенный Jorge E. Hirsch в работе @hirsch2005 и широко используемый для численной оценки продуктивности учёных или научных групп @sciguide. Согласно @hirsch2005, учёный имеет индекс $h$, если им опубликовано как минимум $h$ статей, каждая из которых имеет как минимум $h$ цитирований.

Библиотека Elibrary интегрирована с Российским индексом научного цитирования (РИНЦ) и позволяет получить список публикаций автора через веб-интерфейс, показанный на @fig:elibrary, по уникальному идентификатору автора @elibrary:

![Список публикаций автора в Elibrary](elibrary.png){#fig:elibrary}

Попробуем получить список публикаций автора с идентификатором 260020 при помощи утилиты `curl`:

```bash
~$ curl -s https://elibrary.ru/author_items.asp?authorid=260020
<head><title>Object moved</title></head>
<body>
<h1>Object Moved</h1>
This object may be found <a href="https://www.elibrary.ru/author_items.asp?authorid=260020">here</a>.
</body>
```

Утилита `curl` с опцией `-s` отправляет GET-запрос на заданный адрес, а опция `-s` указывает, что не нужно выводить диагностическую информацию. Судя по полученному ответу, веб-сервер Elibrary перенаправляет нас на новый адрес запрашиваемого HTTP-ресурса. Включим обработку HTTP-заголовка `location` опцией `-L` для автоматических перенаправлений и снова попытаемся получить список публикаций автора с идентификатором 260020:

```bash
~$ curl -s -L https://elibrary.ru/author_items.asp?authorid=260020
<!DOCTYPE html>
<html>
<link rel="stylesheet" href="/style_sm.css" type="text/css" media="screen">
<body>
<div class="midtext">
<img src="/images/error.png" border=0 width=100 height=100 vspace=8><br>
Ошибка в параметрах страницы, <br>или недостаточно прав для открытия страницы.<br>
Уточните запрос или <br>перейдите на <a href="/defaultx.asp">главную страницу сайта</a>
</div>
</body>
</html>
```

Для загрузки списка публикаций нам необходимо авторизоваться и получить идентификатор сессии Elibrary. Для этого достаточно открыть в веб-браузере ссылку @elibrary, войти на сайт Elibrary, включить инструменты разработчика и извлечь значения `SUserID` и `SCookieGUID` из HTTP Cookie для сайта `https://www.elibrary.ru`. Эти значения будут использоваться в дальнейшем при отправке запросов к Elibrary.

Рассмотрим процесс извлечения идентификатора сессии на примере браузера Google Chrome:

* Выполним вход на сайт Elibrary или зарегистрируем новый аккаунт.
* Откроем страницу со списком публикаций автора 260020 на Elibrary @elibrary.
* Включим инструменты разработчика, нажав клавишу F12.
* В панели инструментов разработчика перейдем на вкладку Application.
* В разделе Storage развернём секцию Cookies и выберем `https://www.elibrary.ru`.
* Сохраним значения `SUserID` и `SCookieGUID` (см. @fig:devtools) для дальнейшего использования.

![Идентификатор сессии Elibrary в инструментах разработчика](devtools.png){#fig:devtools}

Вновь попробуем получить список публикаций автора, отправив GET-запрос при помощи `curl` на адрес @elibrary, но уже с опциями `--cookie`, значения для которых были получены на предыдущем шаге:

```bash
~$ curl -s -L -o author.html --cookie "SCookieGUID=%guid%" --cookie "SUserID=%user%" https://elibrary.ru/author_items.asp?authorid=260020
~$ cat author.html | head -n 5

<!DOCTYPE html>
<html>
<head>
<meta name="robots" content="noindex,nofollow">
```

Вместо `%guid%` и `%user%` необходимо подставить значения HTTP Cookie `SCookieGUID` и `SUserID`, полученные из браузера при помощи инструментов разработчика. Опция `-o author.html` используется, чтобы сохранить ответ сервера в файл `author.html` вместо вывода в stdout.

В файле `author.html` теперь находится разметка страницы в формате HTML (Hypertext Markup Language) со сведениями о первых 100 публикациях автора с идентификатором 260020 на Elibrary @elibrary. Для каждой публикации сохранено её название, сведения об авторах, а также число цитирований. Для вычисления индекса Хирша необходимо разобрать HTML-разметку, сохранённую в файле `author.html`, и для каждой из публикаций извлечь число её цитирований.

При работе с языками программирования общего назначения для разбора HTML широко используются специализированные инструменты, выполняющие построение объектной модели документа (Document Object Model, DOM), после чего выполняется обход DOM для извлечения необходимых данных. Например, для разбора HTML в Python можно воспользоваться библиотекой BeautifulSoup @bs4.

Однако, в этом разделе мы намеренно ограничимся только утилитами, доступными в командной оболочке Linux. Сначала убедимся, что в файле `author.html` действительно 100 статей. Анализируя содержимое файла `author.html` легко заметить, что сведения о каждой из статей приведены внутри HTML-тега `tr` с атрибутами `valign` и `id`, причём значение атрибута `id` содержит идентификатор, который может включать в себя как буквы, так и цифры. Воспользуемся утилитами `grep` и `wc` для подсчёта строк, содержащих HTML-тег `tr` с описанными выше атрибутами:

```bash
~$ cat author.html | grep -E '<tr valign=middle id="[a-z0-9]+"' | wc -l
100
```

Опция `-E` переводит утилиту `grep` в расширенный режим с поддержкой регулярных выражений, а опция `-l` указывает, что утилита `wc` должна подсчитать количество строк.

Теперь, аналогичным образом анализируя HTML-разметку, получим HTML-тег с числом цитирований для каждой из статей, на которую есть хотя бы одна ссылка. Ограничим вывод сведениями о первых 5 статьях:

```bash
~$ cat author.html | grep -E 'title="Список статей, ссылающихся на данную">[0-9]+' | head -n 5
<a href="cit_items.asp?gritemid=44028520" title="Список статей, ссылающихся на данную">2</a>
<a href="cit_items.asp?gritemid=37080577" title="Список статей, ссылающихся на данную">50</a>
<a href="cit_items.asp?gritemid=29992112" title="Список статей, ссылающихся на данную">5</a>
<a href="cit_items.asp?gritemid=45625467" title="Список статей, ссылающихся на данную">1</a>
<a href="cit_items.asp?gritemid=61567780" title="Список статей, ссылающихся на данную">1</a>
```

Добавим к `grep` в расширенном режиме опцию `-o`, указывающую, что для каждой строки из stdin, включающей в себя подстроку, соответствующую регулярному выражению `title="Список статей, ссылающихся на данную">[0-9]+`, необходимо выбрать и вывести в stdout только тот фрагмент, который полностью соответствует регулярному выражению:

```bash
~$ cat author.html | grep -E -o 'title="Список статей, ссылающихся на данную">[0-9]+' | head -n 5
title="Список статей, ссылающихся на данную">2
title="Список статей, ссылающихся на данную">50
title="Список статей, ссылающихся на данную">5
title="Список статей, ссылающихся на данную">1
title="Список статей, ссылающихся на данную">1
```

Упростим регулярное выражение в `grep`, после чего повторно применим `grep` для того, чтобы оставить в выводе только число цитирований статей. Затем отсортируем число цитирований по убыванию:

```bash
~$ cat author.html | grep -E -o 'данную">[0-9]+' | grep -E -o '[0-9]+' | sort -n -r | head -n 5
50
50
16
14
13
```

Теперь перейдём к подсчёту индекса Хирша. Поскольку у нас есть отсортированные количества цитирований статей, для подсчёта индекса Хирша воспользуемся следующим алгоритмом: если номер текущей строки меньше или равен значению, расположенному на этой строке, то увеличиваем индекс Хирша на 1.

Этот алгоритм легко реализовать на языке AWK @awk:

```bash
~$ cat author.html | grep -Eo 'данную">[0-9]+' | grep -Eo '[0-9]+' | sort -nr | awk 'NR <= $1 { c += 1 } END { print c }'
7
```

Переменная `NR` увеличивается в AWK на 1 для каждой прочитанной из stdin строки, а переменная `$1` содержит прочитанное значение. Блок `{ c += 1 }` выполняется только в том случае, если условие перед ним истинно. Блок `END { print c }` выполняется после обработки всех строк из stdin и выводит на экран значение переменной `c` – вычисленный индекс Хирша.

Полная версия программы на Bash для вычисления индекса Хирша по 100 публикациям на Elibrary имеет вид:

```bash
~$ curl -s -L --cookie "SCookieGUID=%guid%" --cookie "SUserID=%user%" \
> https://elibrary.ru/author_items.asp?authorid=260020 \
> | grep -Eo 'данную">[0-9]+' \
> | grep -Eo '[0-9]+' \
> | sort -nr \
> | awk 'NR <= $1 { c += 1 } END { print c }'
7
```

Реализованный конвейер показан на @fig:hirschpipe100:

```{#fig:hirschpipe100 .pysvg caption="Конвейер для вычисления индекса Хирша по 100 публикациям" width=60%}  
dot('''
digraph G {
    edge [arrowsize=0.7]
    node [shape=box]
    ranksep=0.3
    rankdir=LR
    1 [label="curl", shape=circle, fixedsize=shape]
    2 [label="grep", shape=circle, fixedsize=shape]
    3 [label="grep", shape=circle, fixedsize=shape]
    4 [label="sort", shape=circle, fixedsize=shape]
    5 [label="awk", shape=circle, fixedsize=shape]
    1 -> 2
    2 -> 3
    3 -> 4
    4 -> 5
}
''')
```

Легко вычислить индекс Хирша по 100 публикациям и для другого автора, заменив `authorid`.

```bash
~$ curl -s -L --cookie "SCookieGUID=%guid%" --cookie "SUserID=%user%" \
> https://elibrary.ru/author_items.asp?authorid=499156 \
> | grep -Eo 'данную">[0-9]+' \
> | grep -Eo '[0-9]+' \
> | sort -nr \
> | awk 'NR <= $1 { c += 1 } END { print c }'
8
```

Если необходимо посчитать индекс Хирша по всем публикациям, то после входа на сайт на странице автора необходимо нажать на ссылку "Вывести на печать список публикаций автора" и разобрать HTML, содержащий все статьи автора, о которых известно научной электронной библиотеке Elibrary:

```bash
~$ open https://elibrary.ru/author_items.asp?authorid=499156
Opening in existing browser session.
~$ curl -s --cookie "SCookieGUID=%guid%" --cookie "SUserID=%user%" \
> https://elibrary.ru/author_items_print.asp \
> | grep -Eo "(</td><td align=center valign=top width=30>|<td align=center valign=top>).*</td></tr>" \
> | sed 's/width=30//' \
> | grep -Eo "[0-9]+" \
> | sort -nr \
> | awk 'NR <= $1 { c += 1 } END { print c }'
25
```

Здесь используется утилита `sed`, выполняющая поиск подстроки `width=30` и её замену на пустую строку.

Реализованный конвейер показан на @fig:hirschpipe:

```{#fig:hirschpipe .pysvg caption="Конвейер для вычисления индекса Хирша по всем публикациям" width=70%}  
dot('''
digraph G {
    edge [arrowsize=0.7]
    node [shape=box]
    ranksep=0.3
    rankdir=LR
    1 [label="curl", shape=circle, fixedsize=shape]
    2 [label="grep", shape=circle, fixedsize=shape]
    3 [label="sed", shape=circle, fixedsize=shape]
    4 [label="grep", shape=circle, fixedsize=shape]
    5 [label="sort", shape=circle, fixedsize=shape]
    6 [label="awk", shape=circle, fixedsize=shape]
    1 -> 2
    2 -> 3
    3 -> 4
    4 -> 5
    5 -> 6
}
''')
```
