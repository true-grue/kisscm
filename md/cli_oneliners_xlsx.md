### Разбор XLSX для поиска бассейнов

В этом разделе рассмотрим задачу обработки табличных данных в формате XLSX (Excel Spreadsheet), полученных из Портала открытых данных Правительства Москвы @datamosru и содержащих сведения о крытых плавательных бассейнах города, для поиска бассейнов длиной более 25 метров. Начнем с экспорта данных в формате XLSX со страницы @datamosru. Загрузить данные со страницы @datamosru можно, нажав на кнопку «экспорт» и выбрав предпочтительный формат или воспользовавшись утилитой `curl`, указав через опцию `-o` имя файла, в который необходимо сохранить загруженный ZIP-архив с таблицей:

```bash
~$ curl -s -o data.zip https://data.mos.ru/odata/export/catalog?idFile=263870
~$ unzip data.zip
Archive:  data.zip
  inflating: data-890-2025-01-17.xlsx
~$ ls
data-890-2025-01-17.xlsx  data.zip
```

Для разбора XLSX-файла воспользуемся утилитой `in2csv` из пакета утилит `csvkit` @csvkit. Преобразуем XLSX-файл, извлечённый из ZIP-архива `data.zip`, в формат CSV. Опция `--reset-dimensions` утилиты `in2csv` позволяет обеспечить поддержку XLSX-таблиц, созданных в приложениях, не сохраняющих в файл с таблицей такие метаданные, как фактическое число строк и столбцов в таблице. Ограничим результат преобразования, выведенный в stdout, первыми 3 строками при помощи утилиты `head`:

```bash
~$ in2csv --reset-dimensions data-890-2025-01-17.xlsx | head -n 3
<frozen importlib._bootstrap>:914: ImportWarning: _SixMetaPathImporter.find_spec() not found; falling back to find_module()
...
```

При работе утилиты `in2csv` в стандартный вывод ошибок (stderr) @sovietov2021scm был напечатан ряд диагностических сообщений. Содержимое stderr можно перенаправить в специальный файл `/dev/null` для игнорирования диагностических сообщений при помощи перенаправления вывода `>` с указанием дескриптора 2, связанного с stderr:

```bash
~$ in2csv --reset-dimensions data-890-2025-01-17.xlsx 2>/dev/null | head -n 3
global_id,ObjectName,NameSummer,PhotoSummer,AdmArea,District,Address,Email,WebSite,HelpPhone,HelpPhoneExtension,WorkingHoursSummer,ClarificationOfWorkingHoursSummer,HasEquipmentRental,EquipmentRentalComments,HasTechService,TechServiceComments,HasDressingRoom,HasEatery,HasToilet,HasWifi,HasCashMachine,HasFirstAidPost,HasMusic,UsagePeriodSummer,DimensionsSummer,Lighting,...
global_id,Название спортивного объекта,Название спортивной зоны ...
2721621929,Бассейн плавательный Московской академии фигурного ...
```

Из содержимого stdout следует, что первые 2 строки в XLSX-файле содержат заголовки столбцов таблицы на английском и русском языках. При этом названия бассейнов приводятся во 2-м столбце с именем `ObjectName`, а сведения о размерах бассейнов – в 26-м столбце с именем `DimensionsSummer`. Передав опцию `--skip-lines` можно указать утилите `in2csv`, что при преобразовании XLSX-таблицы в CSV необходимо пропустить первые 2 строки с заголовками столбцов:

```bash
~$ in2csv --skip-lines 2 --reset-dimensions data-890-2025-01-17.xlsx 2>/dev/null |
head -n 3
2721621929,Бассейн плавательный Московской академии фигурного катания на коньках,"Бассейн плавательный крытый, нестандартного размера","Photo:b96a1334-8eff-4030-9aaa-5754599e9ea3

",Северо-Восточный административный округ,район Южное Медведково,"Заповедная улица, дом 1",mmpa@mossport.ru,mmpa.mossport.ru,(499) 790-30-77,k,"DayOfWeek:понедельник
```

Теперь воспользуемся утилитой `csvcut` из пакета `csvkit` @csvkit, чтобы исключить из полученной таблицы в формате CSV все строки, кроме 2-й, содержащей названия бассейнов, и 26-й, содержащей сведения о размерах бассейнов:

```bash
~$ in2csv --skip-lines 2 --reset-dimensions data-890-2025-01-17.xlsx 2>/dev/null |
csvcut -c 2,26 | head -n 7
Бассейн плавательный Московской академии фигурного катания на коньках,"Square:132.8
Length:16.6
Width:8
Depth:

"
"Спортивный комплекс «Косино», д.8А","Square:400
```

Опция `-c` утилиты `csvcut` позволяет указать через запятую номера тех столбцов, которые необходимо оставить в stdout. Полученный вывод теперь состоит всего из 2 столбцов, но при этом содержимое ячеек и 1-го столбца, и 2-го столбца может включать в себя как символ переноса строки на новую `\n`, так и запятую. Эти символы используются в формате CSV по умолчанию: символ `\n` разделяет строки, а запятая разделяет столбцы. В случае, если ячейка таблицы содержит разделитель, значение ячейки обрамляется двойными кавычками, как показано в выводе утилиты `in2csv` выше. Длина бассейна указана напротив строки `Length:` во втором столбце.

При помощи утилиты `csvformat` заменим разделители строк и столбцов CSV с символов переноса строки и запятой на символ `@` и точку с запятой соответственно. Убедимся, что в выводе теперь отсутствуют двойные кавычки:

```bash
~$ in2csv --skip-lines 2 --reset-dimensions data-890-2025-01-17.xlsx 2>/dev/null |
csvcut -c 2,26 | csvformat -M '@' -D ';' | head -n 7
Бассейн плавательный Московской академии фигурного катания на коньках;Square:132.8
Length:16.6
Width:8
Depth:

@Спортивный комплекс «Косино», д.8А;Square:400
Length:25
```

При помощи утилиты `tr` заменим `@` на символ переноса строки на новую `\n`, а символ `\n` заменим на пробел. Теперь в выводе команды все сведения о бассейне расположены на одной строке – это позволит в дальнейшем воспользоваться инструментами построчной обработки данных:

```bash
~$ in2csv --skip-lines 2 --reset-dimensions data-890-2025-01-17.xlsx 2>/dev/null |
csvcut -c 2,26 | csvformat -M '@' -D ';' | tr '@\n' '\n ' | head -n 3
Бассейн плавательный Московской академии фигурного катания на коньках;Square:132.8 Length:16.6 Width:8 Depth:  
Спортивный комплекс «Косино», д.8А;Square:400 Length:25 Width:16 Depth:2.2  
Бассейн плавательный «ЦСиО Самбо-70 отделение Юность»;Square:128 Length:16 Width:8 Depth:  
```

При помощи утилиты `sed` в расширенном режиме с поддержкой регулярных выражений извлечём из каждой строки название бассейна и длину бассейна. Расширенный режим `sed` включается опцией `-E`:

```bash
~$ in2csv --skip-lines 2 --reset-dimensions data-890-2025-01-17.xlsx 2>/dev/null |
csvcut -c 2,26 | csvformat -M '@' -D ';' | tr '@\n' '\n ' |
sed -E 's/(.+);.*Length:([0-9.]+).*/\1;\2/' | head -n 3
Бассейн плавательный Московской академии фигурного катания на коньках;16.6
Спортивный комплекс «Косино», д.8А;25
Бассейн плавательный «ЦСиО Самбо-70 отделение Юность»;16
```

Указанный в аргументах команды `sed` после `s/` фрагмент регулярного выражения @hopcroft2008 `(.+);` распознаёт от 1 до $\infty$ любых символов, стоящих перед точкой с запятой, и добавляет распознанные символы в первую группу за счёт использования круглых скобок впервые в регулярном выражении, после чего пропускается символ `;`. Затем правило `.*Length:` пропускает от 0 до $\infty$ любых символов, предшествующих строке `Length:`, также пропускается сама строка `Length:`. После этого правилом `([0-9.]+)` распознаётся и добавляется во вторую группу последовательность, содержащая от 1 до $\infty$ символов цифр или символа точки, за счёт повторного использования круглых скобок в регулярном выражении. Наконец, пропускается от 0 до $\infty$ любых оставшихся символов – этому правилу соответствует шаблон `.*`.

Ссылка на первую группу в секции замены `sed` указывается как `\1`, а ссылка на вторую группу – как `\2`. Таким образом, выражение `\1;\2` указывает, что результатом замены, выполняемой утилитой `sed`, должно стать название бассейна, разделитель в виде символа точки с запятой, и длина бассейна.

При помощи программы на языке AWK добавим к таблице заголовок и оставим в выводе только те бассейны, длина которых превышает 25 метров. Преобразуем таблицу в понятное человеку представление при помощи утилиты `csvlook` @csvkit:

```bash
~$ in2csv --skip-lines 2 --reset-dimensions data-890-2025-01-17.xlsx 2>/dev/null |
csvcut -c 2,26 | csvformat -M '@' -D ';' | tr '@\n' '\n ' |
sed -E 's/(.+);.*Length:([0-9.]+).*/\1;\2/' |
awk -F ';' 'BEGIN {print "Бассейн;Длина"} $2 > 25 {print}' |
csvlook --max-column-width 50
| Бассейн                                            | Длина |
| -------------------------------------------------- | ----- |
| Спортивный комплекс «Косино», д.8Б                 |  50,0 |
| Спортивный комплекс «Луч» (плавательный бассейн)   |  25,7 |
| Многофункциональный спортивный комплекс «Формул... |  50,0 |
| Спортивный комплекс высшего учебного заведения     |  29,3 |
| Физкультурно-оздоровительный комплекс с бассейн... |  50,0 |
| Дворец спорта «Москвич»                            |  50,0 |
| Спортивный комплекс «Баланс»                       |  39,0 |
| Спортивный комплекс «Акватория ЗИЛ»                |  50,0 |
| Центр современного пятиборья «Северный»            |  50,0 |
```

В `awk` после однократного выполнения инструкции, указанной в фигурных скобках сразу за ключевым словом `BEGIN`, для каждой строки вычисляется выражение `$2 > 25`, где `$2` обозначает номер колонки. В качестве разделителя колонок используется аргумент опции `-F` утилиты `awk` – точка с запятой. В случае, если выражение `$2 > 25` истинно, выполняется следующая сразу за ним инструкция в фигурных скобках – в stdout печатается строка CSV-таблицы.

Реализованный конвейер показан на @fig:xlsxpipe:

```{#fig:xlsxpipe .pysvg caption="Конвейер для поиска бассейнов длиной более 25 метров в XLSX" width=80%}
dot('''
digraph G {
    edge [arrowsize=0.7]
    node [shape=box]
    ranksep=0.3
    rankdir=LR
    1 [label="in2csv", shape=rect, style="filled,rounded"]
    2 [label="csvcut", shape=rect, style="filled,rounded"]
    3 [label="csvformat", shape=rect, style="filled,rounded"]
    4 [label="tr", shape=circle, fixedsize=shape]
    5 [label="sed", shape=circle, fixedsize=shape]
    6 [label="awk", shape=circle, fixedsize=shape]
    7 [label="csvlook", shape=rect, style="filled,rounded"]
    1 -> 2
    2 -> 3
    3 -> 4
    4 -> 5
    5 -> 6
    6 -> 7
}
''')
```

Белом цветом на @fig:xlsxpipe выделены стандартные утилиты командной оболочки Linux, серым цветом выделены утилиты `in2csv`, `csvcut`, `csvformat` и `csvlook` из пакета утилит `csvkit` @csvkit, который устанавливается отдельно.
